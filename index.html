<!DOCTYPE html>
<html lang="zh-TW">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>校園王APP</title>
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#4a90e2">
	<link rel="stylesheet" href="css/base.css">
	<link rel="stylesheet" href="css/layout.css">
	<link rel="stylesheet" href="css/components.css">
	<link rel="stylesheet" href="css/pages.css">
	
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav id="top-bar">
        <h1 id="app-title">📅 校園王APP</h1>

		<div id="user-info" style="display: none;">
        <div class="user-details" style="text-align: right; margin-right: 10px;">
            <span id="user-badge" style="color: white; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px;">訪客</span>
            <span class="status-text" style="color: #a8e6cf; display: block; font-size: 0.75rem;">● Online</span>
        </div>
        <img id="user-photo" src="" alt="User" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8);">
    </div>
    </nav>

    <div class="dashboard-container">
        
        <aside class="sidebar">
			<div class="nav-menu">
                <button class="nav-btn active" onclick="switchTab('home')" id="btn-home">
                    <span class="icon">🏠</span> <span class="text">首頁概覽</span>
                </button>
                
                <button class="nav-btn" onclick="switchTab('chart')" id="btn-chart">
                    <span class="icon">📈</span> <span class="text">成績趨勢</span>
                </button>

                <button class="nav-btn" onclick="switchTab('credits')" id="btn-credits">
                    <span class="icon">🎓</span> <span class="text">學分進度</span>
                </button>

                <button class="nav-btn" onclick="switchTab('info')" id="btn-info">
                    <span class="icon">ℹ️</span> <span class="text">系統資訊</span>
                </button>

                <button class="nav-btn" onclick="switchTab('settings')" id="btn-settings">
                    <span class="icon">⚙️</span> <span class="text">個人設定</span>
                </button>
            </div>

			<div class="sidebar-footer">
				<button class="nav-btn btn-logout" onclick="logout()">
					<span class="icon">🚪</span> <span class="text">登出系統</span>
				</button>
			</div>
		</aside>

        <main class="main-content">
            
            <div id="view-home">
                <div class="semester-control">
                    <select id="semester-select" class="semester-select" onchange="switchSemester()"></select>
                    <button class="btn-icon" onclick="editSemester()">✏️</button>
                    <button class="btn-icon btn-delete-sem" onclick="deleteSemester()" style="color: #e74c3c;">🗑️</button>
                    <button class="btn-new-sem" onclick="addNewSemester()">+ 新學期</button>
                </div>
                
                <div class="card">
                    <div class="week-tabs">
                        <button class="tab-btn" onclick="switchDay(1)" id="tab-1">一</button>
                        <button class="tab-btn" onclick="switchDay(2)" id="tab-2">二</button>
                        <button class="tab-btn" onclick="switchDay(3)" id="tab-3">三</button>
                        <button class="tab-btn" onclick="switchDay(4)" id="tab-4">四</button>
                        <button class="tab-btn" onclick="switchDay(5)" id="tab-5">五</button>
                    </div>
                    <h2 id="schedule-title">本日課程</h2>
                    <table id="schedule-table">
                        <thead>
                            <tr>
                                <th width="15%">節次</th>
                                <th width="20%">時間</th>
                                <th width="25%">科目</th>
                                <th width="20%">地點</th>
                                <th width="20%">老師</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body"></tbody>
                    </table>
                    <button class="btn btn-add" onclick="openEditModal()">+ 編輯本日課程</button>
                </div>

                <div class="card">
                    <h2>📅 學期行事曆</h2>
                    <div id="calendar-list" style="margin-bottom: 15px;">
                         <p style="color:#999; text-align:center;">載入中...</p>
                    </div>
                    <button class="btn btn-add" onclick="openCalendarModal()">+ 新增活動</button>
                </div>

                <div class="card">
                    <h2>
                            <span>📝 平常考成績</span>
                            <select id="regular-subject-select" style="font-size: 0.9rem; padding: 4px 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="" disabled selected>選擇科目</option>
                            </select>
                    </h2>
                    <table id="regular-exam-table">
                        <thead>
                            <tr>
                                <th width="60%">測驗內容</th>
                                <th width="40%">分數</th>
                            </tr>
                        </thead>
                        <tbody id="regular-exam-body">
                            <tr><td colspan="2" class="no-class">👈 請先選擇科目</td></tr>
                        </tbody>
                    </table>
                    <button class="btn btn-add" onclick="openRegularModal()">+ 登記平常考</button>
                </div>

                <div class="card">
                    <h2>
                            <span>🏆 段考成績</span>
                            <select id="midterm-subject-select" style="font-size: 0.9rem; padding: 4px 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="" disabled selected>選擇科目</option>
                            </select>
                    </h2>
                    <table id="midterm-exam-table">
                        <thead>
                            <tr>
                                <th width="60%">段考名稱</th>
                                <th width="40%">分數</th>
                            </tr>
                        </thead>
                        <tbody id="midterm-exam-body">
                             <tr><td colspan="2" class="no-class">👈 請先選擇科目</td></tr>
                        </tbody>
                    </table>
                    <button class="btn btn-add" onclick="openMidtermModal()">+ 登記段考</button>
                </div>

                <div class="card">
                    <h2>📊 成績單</h2>
                    <table id="grade-table">
                        <thead>
                            <tr>
                                <th>科目</th>
                                <th class="uni-only">學分</th>
                                <th class="uni-only">實得</th>
                                <th>分數</th>
                            </tr>
                        </thead>
                        <tbody id="grade-body"></tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: right; font-weight: bold; color: var(--primary);">
                        <span id="average-score" style="font-size: 1.1rem;">0.0</span>
                    </div>
                    <button class="btn btn-add" onclick="openGradeModal()">+ 編輯成績</button>
                </div>
            </div>
            
            <div id="view-chart" style="display: none;">
                <div class="card" style="height: 80vh; display: flex; flex-direction: column;">
                    <h2>📈 歷年成績趨勢</h2>
                    <div style="flex: 1; position: relative; min-height: 300px;">
                        <canvas id="gradeChart"></canvas>
                    </div>
                    <p style="text-align: center; color: #999; font-size: 0.9rem; margin-top: 10px;">
                        (此圖表統計各學期的平均分數變化)
                    </p>
                </div>
            </div>

            <div id="view-credits" style="display: none;">
                <div class="card">
                    <h2>🎓 畢業學分與模組進度</h2>
                    
                    <div id="credit-progress-container" style="margin-top: 10px;">
                        <h4 style="margin-bottom: 8px; display:flex; justify-content:space-between; font-size:1rem; color:#555;">
                            <span>畢業門檻達成率</span>
                            <span>
                                <span id="total-credits" style="color:var(--primary); font-weight:bold;">0</span> / <span id="target-credits">128</span>
                            </span>
                        </h4>
                        <div style="background: #eee; border-radius: 10px; height: 16px; width: 100%; overflow: hidden; margin-bottom: 5px;">
                            <div id="credit-progress-bar" style="background: var(--primary); width: 0%; height: 100%; transition: width 0.8s ease-in-out;"></div>
                        </div>
                        <p style="font-size: 0.85rem; color: #999; text-align: right; margin-bottom: 25px;">
                            (目標可至「個人設定」頁面修改)
                        </p>

                        <hr style="border: 0; border-top: 1px dashed #ddd; margin-bottom: 20px;">

                        <div id="category-analysis-container">
                            <h4 style="color: #666; font-size: 1rem; margin-bottom: 15px;">📊 各模組詳細狀態</h4>
                            <div id="category-breakdown-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-info" style="display: none;">
                <div class="card">
                    <h2>ℹ️ 關於 校園王APP</h2>
                    <div id="info-content" style="padding: 10px; line-height: 1.6;">
                        <p>這是一個專為學生設計的課表與成績管理工具。</p>
                        <h4 style="color: var(--primary);">使用說明</h4>
                        <ul>
                            <li>點擊「+ 新學期」可以管理不同學期的資料。</li>
                            <li>大學生模式會自動計算加權 GPA。</li>
                            <li>高中生模式專注於分數算術平均。</li>
                        </ul>
                        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                        <p style="font-size:0.9rem; color:#888;">版本：v3.0<br>開發者：校園王團隊</p>
                    </div>
                    <div id="admin-panel" style="display: none; border-top: 2px dashed #ccc; margin-top: 15px; padding-top: 15px;">
                        <h4 style="color: var(--danger);">🛠️ 管理者工具</h4>
                        <textarea id="admin-new-info" style="width:100%; height:80px; margin-bottom:10px;"
                            placeholder="輸入新的公告或資訊..."></textarea>
                        <button class="btn" onclick="addAdminInfo()" style="background: var(--danger);">發布公告</button>
                    </div>
                </div>
            </div>
            
            <div id="view-settings" style="display: none;">
                <div class="card">
                    <h2>⚙️ 一般設定</h2>
                    <div class="settings-list">
                        <div class="settings-item" onclick="resetIdentity()">
                            <div><span class="settings-icon">🪪</span>切換身分 (高中/大學)</div>
                            <span class="settings-arrow">➤</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f4f7f6;">
                        <h2 style="margin: 0; border: none; padding: 0;">📏 學分標準設定</h2>
                        <button id="btn-edit-credits" class="btn" 
                                style="background: #666; padding: 6px 12px; font-size: 0.9rem; width: auto;" 
                                onclick="toggleCreditEdit()">
                            ✏️ 修改
                        </button>
                    </div>
                    <div id="credits-view-mode">
                        <p style="color:#999;">載入中...</p>
                    </div>
                    <div id="credits-edit-mode" style="display: none;">
                        <div style="margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                            <label style="display:block; color:#555; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">畢業總學分目標</label>
                            <input type="number" id="edit-grad-target" class="login-input" style="text-align:center; margin-bottom:0;">
                        </div>
                        <h5 style="margin: 15px 0 10px 0; color: #666; border-left: 4px solid var(--primary); padding-left: 8px;">各模組目標</h5>
                        <div id="category-settings-inputs"></div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="saveCreditSettings()" style="flex: 2; background: var(--primary);">
                                💾 儲存
                            </button>
                            <button class="btn" onclick="toggleCreditEdit()" style="flex: 1; background: transparent; color: #888; border: 1px solid #ddd;">
                                取消
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="color: var(--danger); border-bottom-color: #fff0f0;">🛡️ 帳號管理</h2>
                    <div class="settings-list">
                        <div class="settings-item" onclick="logout()" style="color: var(--danger);">
                            <div><span class="settings-icon">🚪</span>登出帳號</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="login-overlay">
        <div class="login-card">
            <h1 style="margin-top:0;">🎓 歡迎使用</h1>
            <div id="email-form">
                <input type="email" id="email" class="login-input" placeholder="電子信箱 (Email)">
                <input type="password" id="password" class="login-input" placeholder="密碼 (至少6位數)">
                <div style="text-align: right; margin-bottom: 15px; margin-top: -5px;">
                    <span class="text-link" onclick="forgotPassword()" style="font-size: 0.85rem; color: #888;">忘記密碼？</span>
                </div>
                <button class="btn-primary" onclick="handleEmailAuth()" id="btn-submit">登入</button>
                <p style="font-size: 0.9rem; color: #666;">
                    <span id="toggle-text">還沒有帳號？</span>
                    <span class="text-link" onclick="toggleLoginMode()" id="toggle-btn">建立新帳號</span>
                </p>
            </div>
            <div class="divider">或使用其他方式</div>
            <button class="btn-google" onclick="loginWithGoogle()" style="margin-top:0;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Google 登入
            </button>
            <button class="btn-anon" onclick="loginAnonymously()">👻 匿名試用</button>
        </div>
    </div>

    <div id="welcome-modal" class="modal">
        <div class="modal-content">
            <h3>🎓 歡迎使用</h3>
            <p>請問您的身分是？</p>
            <button class="modal-btn" onclick="setUserType('highschool')">我是高中生</button>
            <button class="modal-btn" onclick="setUserType('university')">我是大學生</button>
        </div>
    </div>

    <div id="course-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3 style="text-align: center; margin-top:0;">✏️ 編輯課程</h3>
            <div id="current-course-list" style="margin-bottom: 20px; max-height: 150px; overflow-y: auto;"></div>
            <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">
            <h4 style="margin: 0 0 10px 0; color: var(--primary);">新增一堂課</h4>
            <div class="input-group"><label>節次 (如: 1, 2, A)</label><input type="text" id="input-period" placeholder="輸入節次..."></div>
            <div class="input-group"><label>時間 (如: 08:10)</label><input type="text" id="input-time" placeholder="輸入時間..."></div>
            <div class="input-group">
                <label>課程歸類 & 修別</label>
                <div style="display: flex; gap: 8px;">
                <select id="input-course-category" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="通識">通識教育課程</option>
                    <option value="院共同">院共同課程</option>
                    <option value="基礎">基礎模組</option>
                    <option value="核心">核心模組</option>
                    <option value="專業">專業模組</option>
                    <option value="自由">自由選修</option>
                    <option value="其他">其他</option>
                </select>
                <select id="input-course-nature" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="必修">必修</option>
                    <option value="選修">選修</option>
                    <option value="必選修">必選修</option>
                </select>
                </div>
            </div>
            <div class="input-group"><label>科目</label><input type="text" id="input-subject" placeholder="輸入科目..."></div>
            <div class="input-group"><label>地點</label><input type="text" id="input-room" placeholder="輸入地點..."></div>
            <div class="input-group"><label>老師 (選填)</label><input type="text" id="input-teacher" placeholder="輸入老師..."></div>
             <button id="btn-add-course" class="btn" style="width: 100%; background: #333;" onclick="addCourse()">+ 加入清單</button>
            <button class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: #666; border: 1px solid #ddd;" onclick="closeEditModal()">關閉</button>
        </div>
    </div>

    <div id="grade-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3 style="text-align: center; margin-top:0;">📊 編輯成績</h3>
            <div id="current-grade-list" style="margin-bottom: 20px; max-height: 150px; overflow-y: auto;"></div>
            <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">
            <h4 style="margin: 0 0 10px 0; color: var(--primary);">新增一科</h4>
            <div class="input-group">
                <label>科目名稱</label>
                <div style="display: flex; gap: 8px;">
                    <select id="input-grade-subject-select" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                        <option value="" disabled selected>請先選擇科目</option>
                    </select>
                    <input type="text" id="input-grade-subject-text" style="flex: 1; display: none;" placeholder="請輸入科目名稱...">
                    <button class="btn" id="btn-toggle-input" onclick="toggleGradeInputMode()" style="width: auto; padding: 8px 12px; background: #666;" title="切換輸入模式">✏️</button>
                </div>
            </div>
            <div class="input-group">
                <label>課程歸類 & 修別</label>
                <div style="display: flex; gap: 8px;">
                    <select id="input-grade-category" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="通識">通識教育課程</option>
                        <option value="院共同">院共同課程</option>
                        <option value="基礎">基礎模組</option>
                        <option value="核心">核心模組</option>
                        <option value="專業">專業模組</option>
                        <option value="自由">自由選修</option>
                        <option value="其他">其他</option>
                    </select>
                    <select id="input-grade-nature" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="必修">必修</option>
                        <option value="選修">選修</option>
                        <option value="必選修">必選修</option>
                    </select>
                </div>
            </div>
            <div class="input-group" id="input-credit-group"><label>學分</label><input type="number" id="input-grade-credit" placeholder="例如：3" value="1"></div>
            <div class="input-group"><label>分數</label><input type="number" id="input-grade-score" placeholder="例如：85"></div>
            <button id="btn-add-grade" class="btn" style="width: 100%; background: #333;" onclick="addGrade()">+ 加入成績單</button>
            <button class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: #666; border: 1px solid #ddd;" onclick="closeGradeModal()">關閉</button>
        </div>
    </div>

    <div id="regular-exam-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3 style="text-align: center; margin-top:0;">📝 新增平常考</h3>
            <p style="text-align: center; color: #666;">科目：<span id="modal-regular-subject-name" style="font-weight: bold; color: var(--primary);"></span></p>
            <div class="input-group"><label>測驗名稱</label><input type="text" id="input-regular-name" placeholder="例如：第一次小考、Unit 1"></div>
            <div class="input-group"><label>分數</label><input type="number" id="input-regular-score" placeholder="例如：85"></div>
            <button class="btn" style="width: 100%; background: #333;" onclick="addRegularExam()">+ 確定新增</button>
            <button class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: #666; border: 1px solid #ddd;" onclick="closeRegularModal()">關閉</button>
        </div>
    </div>

    <div id="midterm-exam-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3 style="text-align: center; margin-top:0;">🏆 新增段考</h3>
            <p style="text-align: center; color: #666;">科目：<span id="modal-midterm-subject-name" style="font-weight: bold; color: var(--primary);"></span></p>
            <div class="input-group"><label>段考名稱</label><input type="text" id="input-midterm-name" placeholder="例如：第一次段考、期中考"></div>
            <div class="input-group"><label>分數</label><input type="number" id="input-midterm-score" placeholder="例如：88"></div>
            <button class="btn" style="width: 100%; background: #333;" onclick="addMidtermExam()">+ 確定新增</button>
            <button class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: #666; border: 1px solid #ddd;" onclick="closeMidtermModal()">關閉</button>
        </div>
    </div>

    <div id="calendar-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3 style="text-align: center; margin-top:0;">📅 新增活動</h3>
            <div class="input-group"><label>日期</label><input type="date" id="input-cal-date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
            <div class="input-group"><label>活動名稱</label><input type="text" id="input-cal-title" placeholder="例如：校慶、期末考週..."></div>
            <button class="btn" style="width: 100%; background: #333;" onclick="addCalendarEvent()">+ 加入</button>
            <button class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: #666; border: 1px solid #ddd;" onclick="closeCalendarModal()">關閉</button>
        </div>
    </div>

    <div id="custom-modal" class="modal" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 25px;">
            <h3 id="custom-modal-title" style="margin-top: 0; color: var(--primary); font-size: 1.3rem;">提示</h3>
            
            <p id="custom-modal-message" style="margin: 20px 0; color: #555; line-height: 1.6; font-size: 1rem;"></p>
            
            <div id="custom-modal-input-container" style="display:none; margin-top:15px; margin-bottom: 20px;">
                <input type="text" id="custom-modal-input" class="login-input" style="width:100%; text-align: center;">
            </div>

            <div id="custom-modal-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
            </div>
        </div>
    </div>

    <script src="js/firebase.js"></script>
    <script src="js/state.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/course.js"></script>
    <script src="js/grade.js"></script>
    <script src="js/data.js"></script>
    <script src="js/semester.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/calendar.js"></script>
    <script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }</script>
</body>

</html>